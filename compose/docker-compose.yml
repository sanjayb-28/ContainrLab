version: "3.9"

services:
  web:
    build:
      context: ../frontend
    environment:
      NEXT_PUBLIC_API_BASE: ${NEXT_PUBLIC_API_BASE:-https://app.yourdomain.com}
    ports:
      - "3000:3000"  # expose locally while nginx is not fronting the stack
    depends_on:
      - api
    restart: unless-stopped

  api:
    build:
      context: ..
      dockerfile: backend/Dockerfile
    environment:
      GEMINI_API_KEY_FILE: /run/secrets/gemini_key
      SQLITE_PATH: /data/app.db
      REDIS_URL: redis://redis:6379/0
      RUNNERD_BASE_URL: http://runnerd:8080
      LABS_ROOT: /labs
    secrets:
      - gemini_key
    volumes:
      - ../sqlite:/data
      - ../labs:/labs:ro
    ports:
      - "8000:8000"  # expose API locally for smoke tests and UI development
    depends_on:
      - redis
      - runnerd
    restart: unless-stopped

  runnerd:
    build:
      context: ../runner/supervisor
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - runner_cache:/var/lib/docker
      - ../labs:/labs:ro
    environment:
      NETWORK_NAME: dockrlearn_net
      RUNNER_IMAGE: ${RUNNER_IMAGE:-containrlab-runner:latest}
      LABS_ROOT: /labs
      STARTUP_TIMEOUT: ${RUNNER_STARTUP_TIMEOUT:-30}
    ports:
      - "8080:8080"  # useful for local smoke tests; remove when nginx proxies runnerd internally
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs:/etc/letsencrypt:ro
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - web
      - api
    restart: unless-stopped

volumes:
  runner_cache:

secrets:
  gemini_key:
    file: ./secrets/GEMINI_API_KEY.txt
